library(tidyverse)
library(readxl)
library(geographr)

source("R/utils.R") # download_file() & calculate_extent()

# Technical notes of IMD indicators
# Page 56 https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf
# Was modeled using data from 2015 English Housing Survey

# Data source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
# File 8 on this landing page
tf <- download_file(
  "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
  "xlxs"
)

raw <- read_excel(tf, sheet = "IoD2019 Living Env Domain")

housing <- raw |>
  select(lsoa_code = "LSOA code (2011)", lad_code = "Local Authority District code (2019)", poor_housing_ind = "Housing in poor condition indicator")

pop_lsoa <- population_lsoa |>
  select(lsoa_code, total_population)

housing_extent <- housing |>
  left_join(pop_lsoa, by = "lsoa_code") |>
  calculate_extent(
    var = poor_housing_ind,
    higher_level_geography = lad_code,
    population = total_population,
    invert_percentiles = TRUE #  TRUE when a higher variable score equates to a worse outcome
  )

housing_extent |>
  group_by(extent) |>
  summarise(prop = n() / nrow(housing_extent)) |>
  print(n = Inf)
# 0: 1.9%
# 1: 0.3%

# Save data
housing_extent |>
  write_rds("data/vulnerability/disasters-emergencies/england/housing-quality.rds")

# Note also mention of housing quality in ONS England Health Index See 'Quality of housing' section of ONS health index:
# https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/healthandwellbeing/methodologies/methodsusedtodevelopthehealthindexforengland2015to2018
# 'The potential source for measures of housing quality in terms of the state of repair of the property we identified is data produced by 
# the Ministry of Housing, Communities and Local Government (MHCLG) using the English Housing Survey. These were found to be unsuitable as they 
# cannot be disaggregated to the geographies required for the Health Index.' 

