library(tidyverse)
library(readxl)
library(geographr)

source("R/utils.R") # download_file() & calculate_extent()

# Technical notes of IMD indicators
# Page 52 https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833951/IoD2019_Technical_Report.pdf
# A bespoke geographic information system application was used to calculate the road
# distance to the closest service from the population weighted centroid of each Output
# Area. To create an average road distance for the Lower-layer Super Output Area, a
# population-weighted mean of the Output Area road distances was used. Each Output Area
# score was weighted according to the proportion of the Lower-layer Super Output Area
# population that is within the Output Area, and the weighted scores summed. The Output
# Area level population estimates used for population-weighting were taken from mid-2017
# small area population estimates at Output Area level published by the Office for National
# Statistics.

# Data source: https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019
# File 8 on this landing page
tf <- download_file(
  "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833992/File_8_-_IoD2019_Underlying_Indicators.xlsx",
  "xlxs"
)

raw_imd <- read_excel(tf, sheet = "IoD2019 Barriers Domain")

imd_distance <- raw_imd |>
  select(lsoa_code = "LSOA code (2011)", 
         ltla_code = "Local Authority District code (2019)", 
         supermarket_dist_km = "Road distance to general store or supermarket indicator (km)",
         gp_dist_km = "Road distance to a GP surgery indicator (km)"
         )


# Distances calculated in COVID VI via the following scripts:
# https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/prep%20food%20bank%20accessibility.py
# https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/master/prep%20hospitals%20accessibility.py
# Method: Mean distance to nearest three foodbanks/hospitals from LSOA 2011 Pop Weighted Centroids (doesn't include mental health hospitals) 

covid_vi_foodbank <- read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/foodbank/nearest-foodbanks-lsoas.csv")
covid_vi_hospital <- read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/hospital-data/nearest-hospitals-LSOA.csv")

covid_vi_foodbank_columns <- covid_vi_foodbank |>
  mutate(mean_distance_nearest_three_foodbanks_km = mean_distance_nearest_three_foodbanks / 1000) |>
  distinct(lsoa_code = lsoa11cd, 
           mean_distance_nearest_three_foodbanks_km) |>
  filter(str_detect(lsoa_code, "^E"))

covid_vi_hospital_columns <- covid_vi_hospital |>
  mutate(mean_distance_nearest_three_hospitals_km = mean_distance_nearest_three_hospitals / 1000) |>
  distinct(lsoa_code = lsoa11cd, 
          mean_distance_nearest_three_hospitals_km) |>
  filter(str_detect(lsoa_code, "^E"))


# Use same approach as in COVID-VI https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/bccb08ef4da822d7beb01e56e4a26610bed33b11/create%20vulnerability%20index%20-%20MSOA%20-%20England.r#L149
# Calculate longest mean distance for all the LSOAs within an MSOA
distances_max_msoa <- covid_vi_hospital_columns |>
  full_join(covid_vi_foodbank_columns, by = "lsoa_code") |>
  full_join(imd_distance, by = "lsoa_code") |>
  left_join(lookup_lsoa_msoa, by = "lsoa_code") |>
  group_by(msoa_code) %>% 
  summarise(max_distance_hospitals_km = max(mean_distance_nearest_three_hospitals_km),
            max_distance_foodbanks_km = max(mean_distance_nearest_three_foodbanks_km),
            max_distance_supermarket_km = max(supermarket_dist_km),
            max_distance_gp_km = max(gp_dist_km))


# Use same approach as in COVID-VI https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/bccb08ef4da822d7beb01e56e4a26610bed33b11/create%20vulnerability%20index%20-%20MSOA%20-%20England.r#L304
source("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/functions.r")
# Steps in weighted_domain_scores() function:
# 1. Scale each indicator to Mean = 0, SD = 1
# 2. Perform either PCA or MLFA and extract weights for that domain (use model argument to specify)
# 3. Multiply model weights by respective column to get weighted indicators
# 4. Sum weighted indicators
# 5. Rank and quantise into deciles
distances_mfla <- distances_max_msoa |>
  weighted_domain_scores(model = "MLFA",
                         domain = "Service Distance") |>
  select(msoa_code, `Service Distance Vulnerability score`, `Service Distance Vulnerability rank`, `Service Distance Vulnerability decile`)

# Use same approach as in COVID-VI https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/bccb08ef4da822d7beb01e56e4a26610bed33b11/create%20vulnerability%20index%20-%20LA.r#L86
msoa_pop <- population_msoa |>
  select(msoa_code, total_population)

distances_extent <- distances_mfla |>
  left_join(msoa_pop, by = "msoa_code") |>
  left_join(lookup_msoa_lad, by = "msoa_code") |>
  calculate_extent(
    var = `Service Distance Vulnerability score`,
    higher_level_geography = lad_code,
    population = total_population,
    invert_percentiles = TRUE #  TRUE when a higher variable score equates to a worse outcome
  )

# Save ----
# distances_extent |>
#   write_rds("data/capacity/disasters-emergencies/england/access-services.rds")


