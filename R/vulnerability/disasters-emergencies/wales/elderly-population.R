library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(geographr)
source("R/utils.R")

# Calculate elderly population proportions for MSOAs
elderly_msoa <- 
  population_msoa %>% 
  filter(str_detect(msoa_code, "^W")) %>% 

  pivot_longer(cols = `0`:`90+`, names_to = "Age", values_to = "n_people") %>%
  mutate(Age = as.integer(str_extract(Age, "[0-9]+"))) %>%
  
  group_by(msoa_code) %>%
  summarise(
    num_people = sum(n_people),
    num_people_over_70 = sum(n_people[Age >= 70], na.rm = TRUE)
  ) %>%
  
  mutate(proportion_over_70 = num_people_over_70 / num_people) %>%
  mutate(
    deciles = quantise(
      proportion_over_70,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

# For LAD, calculate extent on proportions
elderly_lad <-
  elderly_msoa %>%
  select(-deciles, -num_people_over_70) %>%
  left_join(lookup_msoa_lad, by = "msoa_code") %>%
  calculate_extent(
    var = proportion_over_70,
    higher_level_geography = lad_code,
    population = num_people
  ) %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

# Save
elderly_msoa %>%
  write_rds("data/vulnerability/disasters-emergencies/wales/elderly-population-msoa.rds")

elderly_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/wales/elderly-population-lad.rds")
