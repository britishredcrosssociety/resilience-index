# Load packages----
library(tidyverse)
library(readxl)
library(demographr)
library(geographr)

source("https://raw.githubusercontent.com/britishredcrosssociety/resilience-index/main/R/utils.R")

# Data Source: Scottish Index of Multiple Deprivation 2020 https://www.gov.scot/publications/scottish-index-of-multiple-deprivation-2020v2-indicator-data/

tf <- download_file(
  "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD%2B2020v2%2B-%2Bindicators.xlsx",
  "xlxs"
)

raw <- read_excel(tf, sheet = "Data", na = "*")

housing <- raw |>
  select(dz_code = Data_Zone, drive_GP, drive_primary,
         drive_retail, drive_secondary) |>
  mutate(index = (drive_GP+drive_primary+drive_secondary+drive_retail)/4)

codes <-lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  select(dz_code = lsoa_11_code, lad_21_code = lad_20_code)

joined_codes <- inner_join(housing, codes, by = "dz_code")

grouped <- joined_codes |>
  group_by(lad_21_code) |>
  summarize(mean_distance_services = mean(index))
