# Load packages----
library(tidyverse)
library(readxl)
library(demographr)
library(geographr)
library(psych)

source("R/utils.R")
# Technical notes on the Scottish Index of Multiple Deprivation 2020
# Page 50 https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/09/simd-2020-technical-notes/documents/simd-2020-technical-notes/simd-2020-technical-notes/govscot%3Adocument/SIMD%2B2020%2Btechnical%2Bnotes.pdf

# Data Source: Scottish Index of Multiple Deprivation 2020 https://www.gov.scot/publications/scottish-index-of-multiple-deprivation-2020v2-indicator-data/

tf <- download_file(
  "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-indicator-data/documents/simd_2020_indicators/simd_2020_indicators/govscot%3Adocument/SIMD%2B2020v2%2B-%2Bindicators.xlsx",
  "xlxs"
)

raw <- read_excel(tf, sheet = "Data", na = "*")

imd_distances <- raw |>
  select(dz_code = Data_Zone,
         drive_GP,
         drive_primary,
         drive_retail,
         drive_secondary)

# Check the correlation between different measures of distances to services
cor(imd_distances[, -1])
alpha(imd_distances[, -1])
describe(imd_distances[, -1], skew = FALSE)

# Create an unweighted scale
imd_distances_scale <- imd_distances |>
  mutate(unweighted_scale = (drive_GP+drive_primary+drive_secondary+drive_retail)/4)

# Check correlation with the unweighted scale
cor(imd_distances_scale[, -1])
alpha(imd_distances_scale[, -1])
describe(imd_distances_scale[, -1], skew = FALSE)

# Create a weighted scale with factor analysis
fa <- factanal(imd_distances[, -1], 
                factors = 1, scores = "regression") 
imd_distances_scale$weighted_scale <- fa$scores
loadings(fa)

describe(imd_distances_scale, skew = FALSE)
round(cor(imd_distances_scale[, c("mean_distance", "weighted_distance")]),3)

# Check if codes are equal
distances_dz <- imd_distances |> 
  distinct(dz_code) |>
  pull()

geographr_codes <- lookup_postcode_oa_11_lsoa_11_msoa_11_lad_20 |>
  select(dz_code = lsoa_11_code, lad_21_code = lad_20_code) |>
  filter(str_detect(lad_21_code, "^S"))

geographr_dz <- geographr_codes |>
  distinct(dz_code) |>
  pull()

if(!(setequal(distances_dz, geographr_dz))) {
  stop("LADS don't match")
} else {
  "LADS match"
}

# Join codes
distances_codes <- left_join(imd_distances_scale, geographr_codes, by = "dz_code") |>
  relocate(lad_21_code)

grouped_distances <- distances_codes |>
  group_by(lad_21_code) |>
  summarize(mean = mean(unweighted_scale),
            max = max(unweighted_scale),
            min = min(unweighted_scale),
            sd = sd(unweighted_scale))
