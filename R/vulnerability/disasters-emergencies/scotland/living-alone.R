# ---- Load ----
library(tidyverse)
library(readxl)
library(httr)
library(geographr)
library(demographr)
source("R/utils.R")

# Load CACI data computed in VI
living_alone_raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

# Filter to Scotland
living_alone_dz <-
  living_alone_raw %>%
  filter(str_detect(LSOA11CD, "^S")) |>
  rename(dz_code = LSOA11CD,
    num_alone = `No. people living alone`) |>
  arrange(num_alone)

head(living_alone_dz)

# Population estimates from IMD
# Source: https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/
GET(
  url = "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/documents/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/govscot%3Adocument/SIMD%2B2020v2%2B-%2Branks.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

# For all ranks: 1 is most deprived, 6,976 is least deprived
imd_raw <- read_excel(tf, sheet = "SIMD 2020v2 ranks")

imd_pop <-
  imd_raw |>
  select(
    dz_code = Data_Zone,
    pop_count = Total_population
  ) |>
  arrange(pop_count)

head(imd_pop)

# Population estimates from demographr
demographr_pop <- population_dz_20 |>
  filter_codes(dz_code, "^S") |>
  filter(sex == "All") |>
  select(dz_code,
         total_population) |>
  arrange(total_population)

head(demographr_pop)

# Compare data zone codes from IMD, demographr and geographr
dz_imd <- imd_pop |> 
  distinct(dz_code) |>
  pull()

dz_demographr <- demographr_pop |>
  distinct(dz_code) |>
  pull()

dz_geographr <- lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  filter(str_detect(msoa11_code, "^S")) |>
  rename(dz_code = lsoa11_code) |>
  distinct(dz_code) |> 
  pull()

if(!(setequal(dz_imd, dz_geographr))) {
  stop("DZ don't match")
} else {
  "DZ match"
}

if(!(setequal(dz_imd, dz_demographr))) {
  stop("DZ don't match")
} else {
  "DZ match"
}

# Are population counts the same?
pop_comparison <- left_join(demographr_pop, imd_pop, by = "dz_code") |>
  mutate(equal = (pop_count == total_population),
         difference = pop_count - total_population)
summary(pop_comparison$difference)
table(pop_comparison$equal)
# No, the population of 6866 out of 6976 Data Zones does not match, and the difference ranges are wide


# Proportion of people living alone
#With IMD
living_alone_prop <-
  living_alone_dz |>
  left_join(imd_pop, by = "dz_code") |>
  mutate(prop_living_alone = num_alone / pop_count) |>
  arrange(prop_living_alone)

living_alone_prop_dz <-
  living_alone_prop |>
  mutate(rank = rank(prop_living_alone)) |>
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  ) |>
  arrange(desc(rank))

head(living_alone_prop_dz)

# With demographr
living_alone_prop_2 <-
  living_alone_dz |>
  left_join(demographr_pop, by = "dz_code") |>
  mutate(prop_living_alone = num_alone / total_population) |>
  arrange(prop_living_alone)

living_alone_prop_dz_2 <-
  living_alone_prop_2 |>
  mutate(rank = rank(prop_living_alone)) |>
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  ) |>
  arrange(desc(rank))

#Compare ranks between IMB and demographr
rank_comparison <- left_join(living_alone_prop_dz, living_alone_prop_dz_2, by = "dz_code") |>
  mutate(equal = (rank.x==rank.y))

table(rank_comparison$equal)

# Add LAD codes and calculate extent
lookup <-
  lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  filter(str_detect(msoa11_code, "^S")) |>
  select(dz_code = lsoa11_code,
         lad_code = ltla20_code) |>
  distinct()

# With IMD
living_alone_prop_lad <-
  living_alone_prop |>
  left_join(lookup, by = "dz_code") |>
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = pop_count,
    weight_high_scores = TRUE
  ) |>
  mutate(rank = rank(extent)) |>
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

# With demographr
living_alone_prop_lad_2 <-
  living_alone_prop_2 |>
  left_join(lookup, by = "dz_code") |>
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE
  ) |>
  mutate(rank = rank(extent)) |>
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

#Compare quantiles between IMB and demographr
dec_comparison <- left_join(living_alone_prop_lad, living_alone_prop_lad_2, by = "lad_code") |>
  mutate(equal = (deciles.x==deciles.y))
table(dec_comparison$equal)

living_alone_prop_dz |>
  write_rds("data/vulnerability/disasters-emergencies/scotland/living-alone-dz.rds")

living_alone_prop_lad |>
  write_rds("data/vulnerability/disasters-emergencies/scotland/living-alone-lad.rds")