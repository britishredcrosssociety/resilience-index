# ---- Load ----
library(tidyverse)
library(readxl)
library(httr)
library(geographr)
source("R/utils.R")

# Load CACI data computed in VI
living_alone_raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

# Filter To Scotland
living_alone_dz <-
  living_alone_raw %>%
  filter(str_detect(LSOA11CD, "^S")) %>%
  rename(
    dz_code = LSOA11CD,
    num_alone = `No. people living alone`
  )

# Population estimates from IMD
# Source: https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/
GET(
  url = "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/documents/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/govscot%3Adocument/SIMD%2B2020v2%2B-%2Branks.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

# For all ranks: 1 is most deprived, 6,976 is least deprived
imd_raw <- read_excel(tf, sheet = "SIMD 2020v2 ranks")

pop_dz <-
  imd_raw %>%
  select(
    dz_code = Data_Zone,
    pop_count = Total_population
  )

living_alone_prop <-
  living_alone_dz %>%
  left_join(pop_dz, by = "dz_code") %>%
  mutate(prop_living_alone = num_alone / pop_count)

living_alone_prop_dz <-
  living_alone_prop %>%
  mutate(rank = rank(prop_living_alone)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

lookup <-
  lookup_dz_iz_lad %>%
  select(dz_code, lad_code) %>%
  distinct()

living_alone_prop_lad <-
  living_alone_prop %>%
  left_join(lookup, by = "dz_code") %>%
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = pop_count
  ) %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

living_alone_prop_dz %>%
  write_rds("data/vulnerability/disasters-emergencies/scotland/living_alone-dz.rds")

living_alone_prop_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/scotland/living_alone-lad.rds")