# Load libraries and functions ----
library(tidyverse)
library(demographr)

source("R/utils.R")

# ---- Load indicators ----
access_services <-
  read_rds("data/vulnerability/disasters-emergencies/scotland/access-services.rds") %>%
  select(
    lad_code,
    distances_extent,
  )

digital_vulnerability <-
  read_rds("data/vulnerability/disasters-emergencies/scotland/digital-vulnerability.rds") %>%
  select(
    lad_code,
    dig_vuln_extent,
  )

disabilities <-
  read_rds("data/vulnerability/disasters-emergencies/scotland/disabilities.rds") %>%
  select(
    lad_code,
    disabilities_prop,
  )

elderly <-
  read_rds("data/vulnerability/disasters-emergencies/scotland/elderly-population.rds") %>%
  select(
    lad_code,
    elderly_extent = extent
  )

housing_quality <-
  read_rds("data/vulnerability/disasters-emergencies/scotland/housing-quality.rds") %>%
  select(
    lad_code,
    poor_housing_ind
  )

living_alone <-
  read_rds("data/vulnerability/disasters-emergencies/scotland/living-alone.rds") %>%
  select(
    lad_code,
    living_alone_extent = extent
  )

# ---- Build Index ----
de <-
  access_services %>%
  left_join(digital_vulnerability) %>%
  left_join(disabilities) %>%
  left_join(elderly) %>%
  left_join(housing_quality) %>%
  left_join(living_alone)

cor(de[,-1], use = "complete.obs")

de <- de %>%
  normalise_indicators() %>%
  calculate_domain_scores(domain_name = "de") %>%
  select(lad_code, deciles = de_domain_quantiles)

de %>%
  write_csv("data/vulnerability/disasters-emergencies/scotland/de-index.csv")