# ---- Load ----
library(dplyr)
library(httr)
library(readxl)
library(geographr)
library(classInt)
source("R/utils.R")

# Source: https://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/
GET(
  url = "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/documents/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/scottish-index-of-multiple-deprivation-2020-ranks-and-domain-ranks/govscot%3Adocument/SIMD%2B2020v2%2B-%2Branks.xlsx",
  write_disk(tf <- tempfile(fileext = ".xlsx"))
)

# For all ranks: 1 is most deprived, 6,976 is least deprived
imd_raw <- read_excel(tf, sheet = "SIMD 2020v2 ranks")

imd_clean <-
  imd_raw %>%
  select(
    dz_code = Data_Zone,
    pop_count = Total_population,
    overall_rank = SIMD2020v2_Rank
  )

imd_dz <-
  imd_clean %>%
  mutate(
    deciles =
      quantise(
        overall_rank,
        num_quantiles = 10,
        highest_quantile_worst = TRUE
      )
  )

# ---- Calculate IZ Deciles ----
# Aggregate dz -> iz
imd_iz_extent <-
  imd_clean %>%
  left_join(lookup_dz_iz_lad, by = "dz_code") %>%
  select(-dz_name, -lad_name, -lad_code) %>%
  relocate(starts_with("iz_"), .after = dz_code) %>%
  calculate_extent(
    var = overall_rank,
    higher_level_geography = iz_code,
    population = pop_count,
    invert_percentiles = FALSE
  )

# Quantise into deciles
# quantise() fun will not work because calcuate_extent() does not permit the
# creation of equal breaks (as only worst 30% receive scores)
imd_iz_rank <-
  imd_iz_extent %>%
  mutate(
    rank = rank(extent)
  )

imd_breaks <- classIntervals(
  imd_iz_rank$rank,
  10,
  style = "fisher"
)

imd_iz <-
  imd_iz_rank %>%
  mutate(
    deciles = as.integer(
      cut(
        rank,
        breaks = imd_breaks$brks,
        include.lowest = TRUE
      )
    )
  )

# ---- Calculate LAD Deciles ----
imd_lad_extent <-
  imd_clean %>%
  left_join(lookup_dz_iz_lad, by = "dz_code") %>%
  select(dz_code, lad_code, pop_count, overall_rank) %>%
  calculate_extent(
    var = overall_rank,
    higher_level_geography = lad_code,
    population = pop_count,
    invert_percentiles = FALSE
  )

imd_lad <-
  imd_lad_extent %>%
  mutate(rank = rank(extent)) %>%
  mutate(
    deciles = quantise(
      rank,
      num_quantiles = 10
    )
  )

write_rds(
  imd_dz,
  "data/vulnerability/disasters-emergencies/scotland/imd-dz.rds"
)
write_rds(
  imd_iz,
  "data/vulnerability/disasters-emergencies/scotland/imd-iz.rds"
)
write_rds(
  imd_lad,
  "data/vulnerability/disasters-emergencies/scotland/imd-lad.rds"
)