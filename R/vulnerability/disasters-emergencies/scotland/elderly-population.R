library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(geographr)
source("R/utils.R")

# Lookup
lookup <-
  lookup_dz_iz_lad %>%
  select(iz_code, lad_code) %>%
  distinct(iz_code, lad_code)

# source: https://www.opendata.nhs.scot/dataset/population-estimates/resource/93df4c88-f74b-4630-abd8-459a19b12f47
pop_sco_raw <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/93df4c88-f74b-4630-abd8-459a19b12f47/download/iz2011-pop-est_02042020.csv")

# Calculate elderly population proportions for IZ
elderly_iz <-
  pop_sco_raw %>%
  filter(Year == max(Year) & IntZone != "S92000003" & Sex == "All") %>%
  pivot_longer(cols = Age0:Age90plus, names_to = "Age", values_to = "n_people") %>%
  mutate(Age = as.integer(str_extract(Age, "[0-9]+"))) %>%
  rename(iz_code = IntZone) %>%
  group_by(iz_code) %>%
  summarise(
    num_people = sum(n_people),
    num_people_over_70 = sum(n_people[Age >= 70], na.rm = TRUE)
  ) %>%
  mutate(proportion_over_70 = num_people_over_70 / num_people) %>%
  mutate(
    deciles = quantise(
      proportion_over_70,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  )

# For LAD, calculate extent on proportions
elderly_lad <-
  elderly_iz %>%
  select(-deciles, -num_people_over_70) %>%
  left_join(lookup, by = "iz_code") %>%
  calculate_extent(
    var = proportion_over_70,
    higher_level_geography = lad_code,
    population = num_people
  ) %>%
  mutate(
    deciles = quantise(
      extent,
      num_quantiles = 10,
      highest_quantile_worst = TRUE
    )
  ) %>%
  select(-extent)

# Save
elderly_iz %>%
  select(iz_code, deciles) %>%
  write_rds("data/vulnerability/disasters-emergencies/scotland/elderly-population-iz.rds")

elderly_lad %>%
  write_rds("data/vulnerability/disasters-emergencies/scotland/elderly-population-lad.rds")