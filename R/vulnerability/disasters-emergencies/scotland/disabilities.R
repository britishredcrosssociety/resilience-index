# Load packages ----
library(tidyverse)
library(nomisr)

source("R/utils.R")
# Load data ----
# Source: https://www.nomisweb.co.uk/query/construct/summary.asp?changing=yes&dataset=17&anal=5&version=0
# Variable: Percentage of working age adults (16 to 64 years old) who are disabled (under the Equality Act) or work-limiting disabled
# Parameter values in nomis_get_data() based on this URL: 

nomisr_raw = nomis_get_data(
  id = "NM_17_5",
  date = "latest",
  geography = "TYPE432", # LADs
  variable = "1733", 
  measures = c("20599", "21001", "21002") # percentage, numerator & denominator
  )

# Date of data (takes latest available data)
unique(nomisr_raw$DATE)

disabilities <- nomisr_raw |>
  select(lad_code = "GEOGRAPHY_CODE",
         lad_name = "GEOGRAPHY_NAME",
         measure = "MEASURES_NAME",
         value ="OBS_VALUE") |>
  filter(measure == "Variable",
         str_detect(lad_code, "^S")) |>
  mutate(disabilities_prop = value / 100) |>
  select(-c(measure, value)) 

disabilities |>
  keep_na()

# Orkney Islands and Shetland Islands are missing

# Compute deciles
disabilities <- disabilities |>
  mutate(rank = rank(disabilities_prop)) |>
  mutate(deciles = quantise(rank, num_quantiles = 10)) |>
  select(-lad_name)
