# Load libraries
library(tidyverse)
library(readxl)
library(demographr)
library(geographr)

source("R/utils.R")

# Load data----
# Data source: Scottish House Condition Survey https://www.gov.scot/publications/scottish-house-condition-survey-local-authority-analysis-2017-2019/
# In this datasets Local Autorithies are only identified by their name and not their code

tf <- download_file(
  "https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2021/02/scottish-house-condition-survey-local-authority-analyses-2017-2019/documents/tables/tables/govscot%3Adocument/tables.xlsx",
  "xlxs"
)

raw <- read_excel(tf, sheet = "SHQS", skip = 4, na = "*")

housing <- raw |>
  select(lad_name = "Local Authority", poor_housing_ind = "% of LA") |>
  filter(lad_name != "Scotland")

housing |>
  mutate(lad_name = fct_reorder(lad_name, desc(poor_housing_ind))) |>
  ggplot(aes(x = lad_name, y = poor_housing_ind)) +
  geom_point() +
  theme_classic() +
  labs(title = "Poor Housing Index by LAD",
       x = "LAD",
       y = "Poor Housing Index") +
  guides(x = guide_axis(angle = 90))


lad_lookup <- boundaries_ltla21 |>
  select(lad_name = ltla21_name,
         lad_code = ltla21_code) |>
  mutate(lad_name = gsub('City of Edinburgh','Edinburgh, City of', lad_name)) |>
  filter(str_detect(lad_code, "^S")) #filter does not work

# Join and compute decile
housing_lad <- left_join(housing, lad_lookup, by = "lad_name") |>
  select(lad_name, lad_code, poor_housing_ind) |>
  mutate(rank = rank(poor_housing_ind)) |>
  mutate(deciles = quantise(rank, num_quantiles = 10)) |>
  select(-lad_name)
