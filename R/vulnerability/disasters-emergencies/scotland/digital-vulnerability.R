# Load packages 
library(tidyverse)
library(demographr)
library(geographr)

source("R/utils.R")

# CACI digital vulnerability data ----
# Provided at the postcode level (for each postcode with more than 6 adults)
# Digital vulnerability is combination of 6 variables:
# fixed internet speed + online purchasing + online finance + mobile phone + internet user + confused by computer

vuln <- read_csv("data/vul_zscores.csv")

dig_vuln <- vuln |>
  filter(region == "Scot") |>
  mutate(postcode = gsub(' ','', postcode)) |>
  select(postcode,
  vul_dig_brdbnd, 
  vul_dig_buyonl,
  vul_dig_manca_net,
  vul_dig_mobnon,
  vul_dig_netusr,
  vul_dig_confuse) 

dig_vuln |>
  pivot_longer(vul_dig_brdbnd:vul_dig_confuse, names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), ncol = 3, scales = "free",
             labeller = as_labeller(c(vul_dig_brdbnd = "Fixed internet speed",
                                      vul_dig_buyonl = "No online purchasing",
                                      vul_dig_manca_net = "No online finance",
                                      vul_dig_mobnon = "No mobile phone",
                                      vul_dig_netusr = "Not internet users",
                                      vul_dig_confuse = "Confused by computers")))

# Use same approach as in COVID-VI https://github.com/britishredcrosssociety/covid-19-vulnerability/blob/bccb08ef4da822d7beb01e56e4a26610bed33b11/create%20vulnerability%20index%20-%20MSOA%20-%20England.r#L304
source("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/functions.r")
# Steps in weighted_domain_scores() function:
# 1. Scale each indicator to Mean = 0, SD = 1
# 2. Perform either PCA or MLFA and extract weights for that domain 
# 3. Multiply model weights by respective column to get weighted indicators
# 4. Sum weighted indicators
# 5. Rank and quantise into deciles

dig_vuln_mfla <- dig_vuln |>
  weighted_domain_scores(model = "MLFA") |>
  select(postcode,
         vulnerability_score = "Vulnerability score",
         vulnerability_rank = "Vulnerability rank",
         vulnerability_decile = "Vulnerability decile")

# Add DZ
postcode_lookup <- lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  filter(str_detect(msoa11_code, "^S")) |>
  select(postcode,
         dz_code = lsoa11_code)

# Check not found in lookup (and vice versa)
nrow(dig_vuln_mfla |> anti_join(postcode_lookup, by = "postcode"))
#0
nrow(postcode_lookup |> anti_join(dig_vuln_mfla, by = "postcode"))
#98876 - it could be because there are less than 6 adults or they could just be missing

dig_vuln_dz <- dig_vuln_mfla |>
  left_join(postcode_lookup, by = "postcode") |>
  group_by(dz_code) |>
  summarise(mean_decile = mean(vulnerability_decile))
  
# Add population
pop_dz <- population_dz_20 |>
  filter_codes(dz_code, "^S") |>
  filter(sex == "All") |>
  select(dz_code,
         total_population)

lad_lookup <- lookup_postcode_oa11_lsoa11_msoa11_ltla20 |>
  filter(str_detect(msoa11_code, "^S")) |>
  select(dz_code = lsoa11_code,
         lad_code = ltla20_code)

#Calculate extent
dig_vuln_lad <- dig_vuln_dz |>
  left_join(lad_lookup, by = "dz_code") |>
  left_join(pop_dz, by = "dz_code") |>
  relocate(dz_code, lad_code) |>
  calculate_extent(
    var = mean_decile,
    higher_level_geography = lad_code,
    population = total_population,
    weight_high_scores = TRUE
  ) |>
  rename(dig_vuln_extent = extent)

dig_vuln_lad |>
  ggplot(aes(y = dig_vuln_extent)) +
  geom_boxplot() +
  ylab("Digital Vulnerability Extent") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
