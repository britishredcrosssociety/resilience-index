# ---- Load ----
library(tidyverse)
library(geographr)
library(sf)

source("R/utils.R")

lookup <-
  lookup_sa_soa_lgd |>
  distinct(soa_code, lad_code = lgd_code)

pop <-
  population_soa |>
  filter(sex == "All") |>
  select(soa_code, total_population)

# Load CACI data computed in VI
raw <-
  read_csv("https://raw.githubusercontent.com/britishredcrosssociety/covid-19-vulnerability/master/data/CACI/living-alone-lsoa.csv")

# Filter to Northern Ireland
living_alone_soa <-
  raw |>
  filter(str_detect(LSOA11CD, "^9")) |>
  rename(
    soa_code = LSOA11CD,
    num_alone = `No. people living alone`
  )

living_alone_prop <-
  living_alone_soa |>
  left_join(pop) |>
  mutate(prop_living_alone = num_alone / total_population)

living_alone <-
  living_alone_prop |>
  left_join(lookup) |>
  calculate_extent(
    var = prop_living_alone,
    higher_level_geography = lad_code,
    population = total_population
  ) |>
  rename(living_alone = extent)

living_alone |>
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/living-alone.rds")