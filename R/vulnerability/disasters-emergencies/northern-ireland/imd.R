library(tidyverse)
library(geographr)
library(sf)
library(readxl)

source("R/utils.R")

lad_lookup <-
  boundaries_lad |>
  st_drop_geometry() |>
  filter(str_detect(lad_code, "^N"))

pop <-
  population_soa |>
  filter(sex == "All") |>
  select(soa_code, total_population)

raw_file <-
  download_file(
    "https://www.nisra.gov.uk/sites/nisra.gov.uk/files/publications/NIMDM17_SOAresults.xls",
    ".xls"
  )

# Rank 1 = most deprived
raw <-
  read_excel(
    raw_file,
    sheet = "MDM"
  )

joined <-
  raw |>
  select(
    lad_name = LGD2014NAME,
    soa_code = SOA2001,
    deprivation = `Multiple Deprivation Measure Rank \n(where 1 is most deprived)`
  ) |>
  left_join(lad_lookup) |>
  left_join(pop) |>
  select(
    lad_code,
    soa_code,
    deprivation,
    total_population
  )

# Lowest rank (!1) = most deprived
imd <-
  joined |>
  mutate(deprivation = invert_this(deprivation)) |>
  calculate_extent(
    deprivation,
    higher_level_geography = lad_code,
    population = total_population
  ) |>
  rename(deprivation = extent)

imd |>
  write_rds("data/vulnerability/disasters-emergencies/northern-ireland/imd.rds")